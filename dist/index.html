<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Pomodoro</title>

		<meta charset='utf-8'>
		<meta name='viewport' content='width=device-width, initial-scale=1.0'>
		<meta name='description' content='Increase your efficiency with the pomodoro time management technique'>

		<link rel='stylesheet' href='css/styles.css' type='text/css' />
		<link rel='shortcut icon' href='images/favicon.ico' type='image/x-icon'>
		<link rel='icon' href='images/favicon.ico' type='image/x-icon'>
	</head>

	<body>
		<div class='container'>
			<div class='content'>
				<div class='page-title'>
					<h1>Pomodoro</h1>
				</div>

				<div class='timers'>
					<div>
						<a rel='pomodoro' class='selected' href='#'>FOCUS</a>
					</div>
					<div>
						<a rel='short_break' href='#'>SHORT BREAK</a>
					</div>
					<div>
						<a rel='long_break' href='#'>LONG BREAK</a>
					</div>
				</div>

				<div class='timer'>
					<div class='pomodoro' data-time='1500' data-orig='25:00'>25:00</div>
					<div class='short_break' data-time='300' data-orig='5:00'>5:00</div>
					<div class='long_break' data-time='600' data-orig='10:00'>10:00</div>
				</div>

				<div class='controls'>
					<div class='timer_button'>
						<a href='#'>start timer</a>
					</div>
					<!--<div class='stop'>
						<a href='#'>STOP</a>
					</div>-->
					<div class='reset'>
						<a href='#'>reset</a>
					</div>
				</div>

				<footer>
					<a class='what' href='#'>WHAT IS POMODORO?</a><a class='test-audio' href='#'>TEST AUDIO</a>
				</footer>
			</div>
		</div>

		<div class='what-modal md-effect'>
			<div class='md-content'>
				<h1>What is Pomodoro?</h1>
				<p><a href='http://pomodorotechnique.com/' target='_BLANK'>Pomodoro</a> is a technique used for time management. It's based on the idea that splitting up work with small breaks can reduce mental fatigue and improve overall productivity.</p>

				<h2>The Pomodoro Flow</h2>

				<ol>
					<li>Work on a task for 25 minutes</li>
					<li>Take a short, 5 minute break</li>
					<li>Repeat</li>
				</ol>

				<p>Every 4th time around, take a longer, 10 minute break</p>

				<aside>Audio courtesy of <a href='http://www.orangefreesounds.com/desk-bell-sound/' target='_BLANK'>Andrew</a></aside>

				<div class='close-modal'><a href='#'>&#215;</a></div>
			</div>
		</div>

		<div class='md-overlay'></div>

		<audio>
			<source src='audio/ding.ogg'></source>
			<source src='audio/ding.mp3'></source>
			<source src='audio/ding.wav'></source>
		</audio>

		<!-- <script src='https://code.jquery.com/jquery-3.4.1.slim.min.js'></script> -->
		<script>
		window.$ = document.querySelectorAll.bind(document);

		Node.prototype.on = window.on = function (name, fn) {
			this.addEventListener(name, fn);
		}

		NodeList.prototype.__proto__ = Array.prototype;

		NodeList.prototype.on = NodeList.prototype.addEventListener = function (name, fn) {
			this.forEach(function (elem, i) {
				elem.on(name, fn);
			});
		}

		var activeTimer;
		var timerStarted = false;
		var timerRunning = false;

		$('.what, .test-audio, .close-modal').on('click', function (e) {
			e.preventDefault();
		});

		$('.timers a').on('click', function (e) {
			e.preventDefault();

			resetTimers();

			if (!timerRunning) {
				// reset timers if one is at 0
				$('.timer > div').each(function () {
					if ($(this).attr('data-time-left') < 1) {
						resetTimers();
					}
				});

				$('.timers a').removeClass('selected');

				var $timers_item = $(e.target);
				$timers_item.addClass('selected');

				var timer_id = '.' + $timers_item.attr('rel');

				$('.timer > div').hide();
				$(timer_id).show();
			}
		});

		$('.timer_button > a').on('click', function (e) {
			e.preventDefault();

			if (!timerRunning) {
				var $timer_span = $('.timer > div').filter(':visible');

				var duration;

				// use "time-left" if timer hasn't been reset
				if ($timer_span.attr('data-time-left') > 0) {
					duration = $timer_span.attr('data-time-left');
				} else {
					resetTimers();
					duration = $timer_span.attr('data-time') - 1;
				}

				startTimer(duration, $timer_span);
			} else {
				pauseTimer();
			}
		});

		$('.reset > a').on('click', function (e) {
			e.preventDefault();
			pauseTimer();
			resetTimers();
		});

		$('.what, .md-overlay, .close-modal').on('click', function () {
			$('.what-modal').toggleClass('md-show');
		});

		$('.test-audio').on('click', function () {
			ding();
		});

		function startTimer(duration, timer_span) {
			var timer = duration, minutes, seconds;

			activeTimer = setInterval(function () {
				minutes = parseInt(timer / 60, 10)
				seconds = parseInt(timer % 60, 10);

				seconds = seconds < 10 ? "0" + seconds : seconds;

				document.title = 'Pomodoro (' + minutes + ':' + seconds + ')';
				timer_span.text(minutes + ':' + seconds);
				timer_span.attr('data-time-left', timer);

				if (--timer < 0) {
					resetTimers();

					ding();

					document.querySelector('.timer').classList.add('shaking');

					setTimeout(() => {
						document.querySelector('.timer').classList.remove('shaking');
					}, 684); // matches CSS: 38ms per animation cycle * 15 cycles
				}
			}, 1000);

			timerStarted = true;
			timerRunning = true;

			showButton('pause');
		}

		function pauseTimer() {
			window.clearInterval(activeTimer);
			timerRunning = false;

			showButton('start');
		}

		// resets all timers to original positions
		function resetTimers() {
			$('.timer > div').each(function () {
				$(this).removeAttr('data-time-left').text($(this).attr('data-orig'));
			});

			window.clearInterval(activeTimer);

			timerStarted = false;
			timerRunning = false;

			showButton('start');
		}

		function showButton(toggleVal) {
			if (toggleVal === 'start') {
				const textStr = (timerStarted) ? 'resume timer' : 'start timer';

				$('.timer_button > a').removeClass('running').text(textStr);
			} else if (toggleVal === 'pause') {
				$('.timer_button > a').addClass('running').text('pause timer');
			}
		}

		function ding() {
			$('audio')[0].play();
		}
		</script>

		<!--[if lt IE 9]>
		<script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
	</body>
</html>
